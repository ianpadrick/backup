public class LoanStageDurationController {

    private List<AggregateResult> stages;
    private List<LLC_BI__CFG_ConfigValue__c> closed;
    private List<LLC_BI__CFG_ConfigValue__c> complete;
    public String closedStage;
    public String completeStage;
    public boolean hide {get; set;}
    Id recordId = ApexPages.currentPage().getParameters().get('id');
    
    public LoanStageDurationController(ApexPages.StandardController stdController) {

        List<LLC_BI__CFG_ConfigValue__c> closed = [SELECT LLC_BI__fieldValue__c
                                                FROM LLC_BI__CFG_ConfigValue__c
                                                WHERE (LLC_BI__Key__c = 'ALL'
                                                OR LLC_BI__Key__c = 'Closed')
                                                AND LLC_BI__Category__c = 'Loan Stage' LIMIT 1];
        if(closed.isEmpty()){
          ApexPages.addmessage(new ApexPages.Message(ApexPages.Severity.ERROR, 'Please setup the correct configuration values for Complete and Closed Funded in CFG_ConfigValue object.'));
          hide = true;
        }else{
          closedStage = closed.get(0).LLC_BI__fieldValue__c;
          hide = false;
        }

        List<LLC_BI__CFG_ConfigValue__c> complete = [SELECT LLC_BI__fieldValue__c
                                                    FROM LLC_BI__CFG_ConfigValue__c
                                                    WHERE LLC_BI__Key__c = 'Complete' LIMIT 1];

        if(complete.isEmpty()){
          ApexPages.addmessage(new ApexPages.Message(ApexPages.Severity.ERROR, 'Please setup the correct configuration values for Complete and Closed Funded in CFG_ConfigValue object.'));
          hide = true;
        }else{
          completeStage = complete.get(0).LLC_BI__fieldValue__c;
          hide = false;
        }

        stages = [SELECT LLC_BI__StageName__c, MAX(LLC_BI__Stage_Duration__c) stage, MAX(CreatedDate)
                  FROM LLC_BI__Opportunity_History__c
                  WHERE LLC_BI__Loan__r.Id =: recordId 
                  AND LLC_BI__StageName__c !=: closedStage
                  AND LLC_BI__StageName__c !=: completeStage
                  GROUP BY LLC_BI__StageName__c
                  ORDER BY MAX(CreatedDate) DESC];
    }
 
    public List<AggregateResult> stagesList {
        get {return stages;}
    }
}